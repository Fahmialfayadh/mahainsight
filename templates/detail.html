{% extends "base.html" %}

{% block title %}{{ post.title }} - MahaInsight{% endblock %}
{% block description %}{{ post.preview }}{% endblock %}

{% block content %}
<article class="pt-28 md:pt-32 pb-20">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Header -->
        <header class="text-center mb-12">
            <!-- Meta -->
            <div class="flex items-center justify-center gap-3 text-sm text-slate-500 mb-6">
                <span class="flex items-center gap-1.5 bg-slate-50 px-3 py-1 rounded-full border border-slate-100">
                    <i class="bi bi-calendar3"></i>
                    {{ post.created_at[:10] if post.created_at else 'N/A' }}
                </span>
                {% if post.source_name %}
                <span class="flex items-center gap-1.5 bg-slate-50 px-3 py-1 rounded-full border border-slate-100">
                    <i class="bi bi-building"></i>
                    {{ post.source_name }}
                </span>
                {% endif %}
            </div>

            <h1 class="text-4xl md:text-5xl font-display font-bold text-slate-900 leading-tight mb-8">
                {{ post.title }}
            </h1>
        </header>

        <!-- Visualization / Thumbnail -->
        {% if post.thumbnail_url %}
        <figure class="mb-12 rounded-3xl overflow-hidden shadow-2xl shadow-brand-900/5 ring-1 ring-slate-900/5">
            <img src="{{ post.thumbnail_url }}" alt="{{ post.title }}" class="w-full h-auto">
        </figure>
        {% endif %}

        <!-- Interactive Plotly Visualizations (supports multiple) -->
        {% if post.viz_urls or post.viz_url %}
        <section class="mb-12 space-y-6" id="visualization-section">
            {% set visualizations = post.viz_urls|default([]) %}
            {% if post.viz_url and not post.viz_urls %}
            {% set visualizations = [{'url': post.viz_url, 'title': 'Visualisasi'}] %}
            {% endif %}

            {% for viz in visualizations %}
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden viz-card"
                id="viz-{{ loop.index }}">
                <!-- Simple Header -->
                <div class="px-5 py-3 border-b border-slate-100 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span
                            class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center text-slate-600 text-sm font-semibold">
                            {{ loop.index }}
                        </span>
                        <h3 class="font-medium text-slate-800 text-sm">
                            {{ viz.title|default('Visualisasi ' ~ loop.index) }}
                        </h3>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="toggleVizFullscreen({{ loop.index }})"
                            class="p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-50 transition"
                            title="Fullscreen">
                            <i class="bi bi-arrows-fullscreen text-sm" id="fs-icon-{{ loop.index }}"></i>
                        </button>
                        <a href="{{ viz.url }}" target="_blank"
                            class="p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-50 transition"
                            title="Buka di Tab Baru">
                            <i class="bi bi-box-arrow-up-right text-sm"></i>
                        </a>
                    </div>
                </div>

                <!-- Visualization Container -->
                <div class="relative" id="viz-container-{{ loop.index }}">

                    <!-- Mobile: Show placeholder with "View Interactive" button -->
                    <div class="md:hidden">
                        <div
                            class="aspect-[4/3] bg-slate-100 flex flex-col items-center justify-center p-6 text-center viz-placeholder-{{ loop.index }}">
                            <i class="bi bi-graph-up text-4xl text-slate-300 mb-3"></i>
                            <p class="text-sm text-slate-500 mb-4">Visualisasi interaktif tersedia</p>
                            <button
                                onclick="openVizFocusMode({{ loop.index }}, '{{ url_for('viz_proxy', url=viz.url) }}')"
                                class="px-5 py-2.5 bg-slate-900 text-white text-sm font-medium rounded-xl hover:bg-slate-800 transition flex items-center gap-2">
                                <i class="bi bi-arrows-fullscreen"></i> Lihat Visualisasi Interaktif
                            </button>
                            <p class="text-xs text-slate-400 mt-3">Ketuk untuk mode fokus (zoom & pan)</p>
                        </div>
                    </div>

                    <!-- Desktop: Show iframe directly -->
                    <div class="hidden md:block">
                        <div id="vizLoading-{{ loop.index }}"
                            class="absolute inset-0 flex items-center justify-center bg-white z-10">
                            <div class="text-center">
                                <div
                                    class="inline-block animate-spin rounded-full h-8 w-8 border-3 border-slate-200 border-t-slate-600 mb-2">
                                </div>
                                <p class="text-xs text-slate-400">Memuat visualisasi...</p>
                            </div>
                        </div>
                        <div class="h-[550px]">
                            <iframe data-src="{{ url_for('viz_proxy', url=viz.url) }}"
                                class="w-full h-full border-0 viz-iframe"
                                onload="this.dataset.loaded && document.getElementById('vizLoading-{{ loop.index }}').classList.add('hidden')"
                                loading="lazy"></iframe>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </section>
        {% endif %}

        <!-- Action Bar - Static on mobile, sticky on desktop -->
        <div class="md:top-24 z-30 mb-8">
            <div
                class="bg-white/90 backdrop-blur-md border border-slate-200 shadow-sm rounded-xl p-2 flex flex-wrap justify-center gap-1 md:gap-2 max-w-fit mx-auto">



                <!-- primary ACTIONS -->
                {% if post.data_url %}
                <button onclick="previewData('{{ post.data_url }}')"
                    class="px-4 py-2 rounded-xl text-sm font-medium text-slate-700 bg-slate-50 hover:bg-slate-100 transition flex items-center gap-2">
                    <i class="bi bi-table"></i> Preview Data
                </button>
                {% endif %}

                {% if post.source_link %}
                <a href="{{ post.source_link }}" target="_blank" rel="noopener noreferrer"
                    class="px-4 py-2 rounded-xl text-sm font-medium text-slate-700 bg-slate-50 hover:bg-slate-100 transition flex items-center gap-2">
                    <i class="bi bi-box-arrow-up-right"></i> Sumber
                </a>
                {% endif %}

                <a href="#ai-chat"
                    class="px-5 py-2.5 rounded-xl text-sm font-semibold text-slate-800 bg-slate-200 hover:bg-slate-300 shadow-md shadow-slate-300/40 transition flex items-center gap-2">
                    <i class="bi bi-chat-dots-fill"></i> Vercax AI
                </a>
                <!-- CTA -->
                {% if post.petasight_link %}
                <a href="{{ post.petasight_link }}" target="_blank" rel="noopener noreferrer"
                    class="px-4 py-2 rounded-xl text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 shadow-lg shadow-brand-500/20 transition flex items-center gap-2">
                    <i class="bi bi-map-fill"></i> Petasight
                </a>
                {% endif %}
                <!-- secondary MENU -->
                <div class="relative group">
                    <button
                        class="px-4 py-2 rounded-xl text-sm font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-2">
                        <i class="bi bi-three-dots"></i> Lainnya
                    </button>

                    <div
                        class="absolute top-full right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-slate-100 p-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-right z-50">

                        <a href="#content"
                            class="px-3 py-2 rounded-lg text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                            <i class="bi bi-text-paragraph"></i> Baca Artikel
                        </a>

                        <!-- Font Switcher -->
                        <div class="mt-1 border-t border-slate-100 pt-1">
                            <div class="px-3 py-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">
                                Font
                            </div>
                            <div id="font-options-container">
                                <!-- injected by JS -->
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>


        <!-- Content - Paper/Canvas Style -->
        <div class="bg-[#FFFDF9] rounded-2xl shadow-lg shadow-slate-200/50 ring-1 ring-slate-100 p-6 sm:p-10 md:p-12">
            <div id="content" style="font-family: var(--article-font, var(--font-body))"
                class="prose prose-lg prose-slate max-w-none prose-headings:font-display prose-headings:font-bold prose-a:text-brand-600 hover:prose-a:text-brand-700 prose-img:rounded-2xl">
                {{ post.content_html|safe }}
            </div>
        </div>

        <!-- AI Assistant Section -->
        {% if session.get('user_id') %}
        <div id="ai-chat">
            <div
                class="mt-8 bg-white rounded-2xl shadow-lg shadow-slate-200/50 ring-1 ring-slate-100 p-6 sm:p-10 border-t-4 border-brand-500">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-display font-bold text-slate-900 flex items-center gap-2">
                        <i class="bi bi-robot text-brand-600"></i> Vercax AI
                    </h2>
                    <span class="px-3 py-1 bg-brand-50 text-brand-700 text-sm font-medium rounded-full"
                        id="ai-counter-badge">
                        <i class="bi bi-chat-dots"></i> Memuat...
                    </span>
                </div>

                <!-- Summary Section -->
                <div class="mb-8 p-6 bg-slate-50 rounded-xl">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-slate-800">Ringkasan Artikel</h3>
                        <button onclick="generateSummary()" id="btn-summary"
                            class="px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg text-sm hover:bg-slate-100 transition shadow-sm">
                            <i class="bi bi-magic mr-1"></i> Generate Summary
                        </button>
                    </div>
                    <div id="ai-summary-content" class="prose prose-sm text-slate-600 hidden">
                        <!-- Summary injected here -->
                    </div>
                    <div id="summary-loading" class="hidden flex items-center gap-2 text-slate-500 text-sm">
                        <div class="w-4 h-4 border-2 border-brand-500 border-t-transparent rounded-full animate-spin">
                        </div>
                        Sedang meringkas...
                    </div>
                </div>

                <!-- Chat Interface -->
                <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <div id="chat-history" class="h-[30vh] overflow-y-auto p-4 bg-slate-50 flex flex-col gap-3">
                        <div class="flex gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 shrink-0">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div
                                class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 max-w-[85%]">
                                Halo! Saya Vercax, AI dari MahaLabs. Ada yang ingin ditanyakan tentang data di artikel
                                ini?
                            </div>
                        </div>
                    </div>
                    <div class="p-3 bg-white border-t border-slate-200 flex gap-2">
                        <input type="text" id="chat-input"
                            class="flex-1 px-4 py-2 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-500"
                            placeholder="Tanya tentang insight data...">
                        <button onclick="sendChat()" id="btn-send"
                            class="px-4 py-2 bg-brand-600 text-white rounded-xl hover:bg-brand-700 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <div
                class="mt-8 bg-gradient-to-br from-brand-600 to-indigo-600 rounded-2xl shadow-lg p-8 text-center text-white">
                <div
                    class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="bi bi-robot text-3xl"></i>
                </div>
                <h2 class="text-2xl font-display font-bold mb-2">Buka Vercax AI</h2>
                <p class="text-brand-100 mb-6 max-w-lg mx-auto">Dapatkan ringkasan instan dan tanya jawab interaktif
                    tentang
                    data di artikel ini. Daftar gratis sekarang!</p>
                <div class="flex gap-4 justify-center">
                    <a href="{{ url_for('register_page') }}"
                        class="px-6 py-3 bg-white text-brand-600 font-semibold rounded-xl hover:bg-brand-50 transition shadow-lg">Daftar
                        Akun</a>
                    <a href="{{ url_for('login_page', next=request.path) }}"
                        class="px-6 py-3 bg-brand-700/50 text-white font-semibold rounded-xl hover:bg-brand-700 transition backdrop-blur-sm border border-brand-500">Masuk</a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Source Footer -->
        {% if post.source_name or post.source_link %}
        <div class="mt-16 pt-8 border-t border-slate-100">
            <div class="bg-slate-50 rounded-2xl p-6 border border-slate-100">
                <h3 class="font-display font-semibold text-slate-900 mb-2 flex items-center gap-2">
                    <i class="bi bi-info-circle text-brand-500"></i> Referensi Data
                </h3>
                <p class="text-sm text-slate-500 mb-0">
                    Analisis ini didasarkan pada data dari
                    {% if post.source_name %}
                    <span class="font-medium text-slate-700">{{ post.source_name }}</span>.
                    {% endif %}

                    {% if post.source_link %}
                    <a href="{{ post.source_link }}" target="_blank"
                        class="block mt-2 text-brand-600 hover:text-brand-700 truncate">
                        {{ post.source_link }}
                    </a>
                    {% endif %}
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Back Link -->
        <div class="mt-12 text-center">
            <a href="{{ url_for('index') }}"
                class="inline-flex items-center gap-2 text-slate-500 hover:text-brand-600 transition font-medium">
                <i class="bi bi-arrow-left"></i> Kembali ke Eksplorasi
            </a>
        </div>

    </div>
</article>

<!-- Data Preview Modal -->
<div id="dataModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity opacity-0" id="modalBackdrop"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <!-- Modal Panel -->
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl opacity-0 scale-95"
                id="modalPanel">

                <!-- Header -->
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 border-b border-slate-100 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-display font-bold leading-6 text-slate-900" id="modal-title">Preview
                            Data</h3>
                        <p class="mt-1 text-sm text-slate-500">Menampilkan 20 baris pertama dari dataset.</p>
                    </div>
                    <button type="button" onclick="closeModal()" class="text-slate-400 hover:text-slate-500 transition">
                        <i class="bi bi-x-lg text-xl"></i>
                    </button>
                </div>

                <!-- Body -->
                <div class="px-4 py-4 sm:p-6 bg-slate-50/50 max-h-[60vh] overflow-auto">
                    <div id="loadingState" class="hidden text-center py-12">
                        <div
                            class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-brand-100 border-t-brand-600 mb-4">
                        </div>
                        <p class="text-sm text-slate-500 font-medium">Memuat data...</p>
                    </div>

                    <div id="errorState" class="hidden text-center py-12">
                        <div
                            class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-red-100 text-red-600 mb-4">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <p class="text-slate-900 font-medium mb-1">Gagal memuat data</p>
                        <p class="text-sm text-slate-500" id="errorMessage">Format file mungkin tidak didukung.</p>
                    </div>

                    <div id="tableContainer"
                        class="overflow-x-auto rounded-lg border border-slate-200 shadow-sm bg-white">
                        <!-- Table will be injected here -->
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-white px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-slate-100 gap-3">
                    <a id="downloadBtn" href="#" target="_blank" download
                        class="inline-flex w-full justify-center rounded-xl bg-brand-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-brand-500 sm:w-auto gap-2 items-center transition">
                        <i class="bi bi-download"></i> Download Full Data
                    </a>
                    <button type="button" onclick="closeModal()"
                        class="mt-3 inline-flex w-full justify-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto transition">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- PapaParse for CSV Parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<!-- Marked for Markdown Rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    // Define global variable for external script
    const CURRENT_POST_ID = {{ post.id }};
</script>
<script src="{{ url_for('static', filename='js/detail.js') }}"></script>
<script src="{{ url_for('static', filename='js/font-manager.js') }}"></script>
{% endblock %}